# Copyright 2026 The Tekton Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# TriggerTemplate for tektoncd/pipeline releases.
# Uses the git resolver to fetch the release pipeline directly from
# the project's release branch â€” no pre-installation needed.
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: pipeline-release-automation
spec:
  params:
  - name: buildID
    description: Build UUID for tracking
  - name: gitRepository
    description: Git repository URL (e.g., https://github.com/tektoncd/pipeline)
  - name: gitRevision
    description: Git revision (commit SHA)
  - name: releaseBranch
    description: Release branch name (e.g., release-v1.9.x)
  - name: projectName
    description: Project name (e.g., pipeline)
  - name: repositoryFullName
    description: Full repository name (e.g., tektoncd/pipeline)
  - name: releaseVersion
    description: Release version number (e.g., v1.9.1)
    default: ""
  - name: previousVersion
    description: Previous release version tag (e.g., v1.9.0) for changelog generation
    default: ""
  - name: triggerSource
    description: Trigger source (webhook or cron)
  - name: afterCommitSha
    description: Commit SHA that triggered the release
  - name: releaseAsLatest
    description: Whether to publish this release as latest
    default: "false"
  resourcetemplates:
  - apiVersion: tekton.dev/v1
    kind: PipelineRun
    metadata:
      generateName: pipeline-release-
      labels:
        tekton.dev/kind: release
        release.tekton.dev/project: pipeline
        release.tekton.dev/branch: $(tt.params.releaseBranch)
        release.tekton.dev/trigger: $(tt.params.triggerSource)
    spec:
      taskRunTemplate:
        serviceAccountName: release-automation
      # Fetch the release pipeline from the project's own release branch.
      # This ensures we always use the pipeline definition that matches
      # the branch being released, including its publish task, precheck, etc.
      pipelineRef:
        resolver: git
        params:
        - name: url
          value: https://github.com/tektoncd/pipeline
        - name: revision
          value: $(tt.params.releaseBranch)
        - name: pathInRepo
          value: tekton/release-pipeline.yaml
      params:
      - name: package
        value: github.com/tektoncd/pipeline
      - name: repoName
        value: pipeline
      - name: gitRevision
        value: $(tt.params.afterCommitSha)
      - name: imageRegistry
        value: ghcr.io
      - name: imageRegistryPath
        value: tektoncd/pipeline
      - name: imageRegistryRegions
        value: ""
      - name: imageRegistryUser
        value: tekton-robot
      - name: versionTag
        value: $(tt.params.releaseVersion)
      - name: releaseBucket
        value: tekton-releases
      - name: releaseAsLatest
        value: $(tt.params.releaseAsLatest)
      - name: previousReleaseTag
        value: $(tt.params.previousVersion)
      - name: serviceAccountImagesPath
        value: credentials
      - name: koExtraArgs
        value: ""
      timeouts:
        pipeline: 3h0m0s
      workspaces:
      - name: workarea
        volumeClaimTemplate:
          spec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 5Gi
      - name: release-secret
        secret:
          secretName: oci-release-secret
      - name: release-images-secret
        secret:
          secretName: ghcr-creds
      - name: github-secret
        secret:
          secretName: github-token
