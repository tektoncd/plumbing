# Cherry Pick Command Workflow
#
# This workflow is triggered by the /cherry-pick slash command from the slash.yml workflow.
# It automatically cherry-picks merged PRs to the specified target branches.
#
# Usage: Comment `/cherry-pick <target-branch> [<target-branch> ...]` on a merged pull request
# Example: `/cherry-pick release-v0.47.x`
# Example: `/cherry-pick release-v0.47.x release-v1.3.x`
#
# Security Notes:
# - Only users with "write" permission can trigger this command (enforced in slash.yml)
# - Works safely with PRs from forks because it only cherry-picks already-merged commits
# - Uses CHATOPS_TOKEN to create PRs and push to branches
# - The action creates a new branch from the target branch, not from the fork
#
# To use this in a repo
#
# name: Cherry Pick Actions
# on:
#   repository_dispatch:
#     types: [cherry-pick-command]
#
# jobs:
#   cherry-pick:
#     name: Cherry Pick Actions
#     uses: tektoncd/plumbing/.github/worflows/_cherry-pick-command.yaml@main

name: Cherry Pick Command

on:
  workflow_call:
    secrets:
      CHATOPS_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.parse-args.outputs.branches }}
      error: ${{ steps.parse-args.outputs.error }}
      message: ${{ steps.parse-args.outputs.message }}
    steps:
      - name: Add reaction to trigger comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.CHATOPS_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: "+1"

      - name: Get target branches from command args
        id: parse-args
        run: |
          # Parse all unnamed arguments from the slash command
          ARGS_JSON='${{ toJson(github.event.client_payload.slash_command.args.unnamed) }}'

          # Extract branch names from the JSON object, filtering out "all" field if present
          # The unnamed args come as {arg1: "branch1", arg2: "branch2", ...}
          BRANCHES=$(echo "$ARGS_JSON" | jq -r '[to_entries[] | select(.key | startswith("arg")) | .value | select(. != null and . != "")] | @json')

          echo "Parsed branches: $BRANCHES"

          if [ "$BRANCHES" = "[]" ] || [ -z "$BRANCHES" ]; then
            echo "error=true" >> $GITHUB_OUTPUT
            echo "message=Missing target branch(es). Usage: /cherry-pick <target-branch> [<target-branch2> ...]" >> $GITHUB_OUTPUT
          else
            echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
            echo "error=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on error
        if: steps.parse-args.outputs.error == 'true'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.CHATOPS_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            ‚ùå **Cherry-pick failed**: ${{ steps.parse-args.outputs.message }}

            **Usage**: `/cherry-pick <target-branch> [<target-branch2> ...]`
            **Examples**:
            - `/cherry-pick release-v1.0`
            - `/cherry-pick release-v1.0 release-v1.1 release-v2.0`

  cherry-pick:
    needs: prepare
    if: needs.prepare.outputs.error == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(needs.prepare.outputs.branches) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.CHATOPS_TOKEN }}
          fetch-depth: 0

      - name: Perform cherry-pick
        id: cherry-pick
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.CHATOPS_TOKEN }}
          TARGET_BRANCH: ${{ matrix.branch }}
          PR_NUMBER: ${{ github.event.client_payload.pull_request.number }}
        run: |
          set -e  # Exit on error to catch unexpected failures

          # Capture all output
          OUTPUT_FILE=$(mktemp)
          ERROR=""

          {
            echo "ü§ñ Starting cherry-pick process..."

            git config user.name "Tekton Bot"
            git config user.email "tekton-bot@users.noreply.github.com"

            # Get PR information
            echo "Fetching PR #$PR_NUMBER information..."
            PR_DATA=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json state,mergeCommit,mergedAt,title,body) || ERROR="Failed to fetch PR information"
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            # Check if PR is merged
            PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
            MERGED_AT=$(echo "$PR_DATA" | jq -r '.mergedAt')
            if [ "$PR_STATE" != "MERGED" ] || [ "$MERGED_AT" = "null" ]; then
              echo "‚ùå ERROR: PR #$PR_NUMBER is not merged yet (state: $PR_STATE). Cherry-pick requires merged PRs."
              exit 1
            fi

            MERGE_COMMIT=$(echo "$PR_DATA" | jq -r '.mergeCommit.oid')
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
            PR_BODY=$(echo "$PR_DATA" | jq -r '.body')
            echo "Found merge commit: $MERGE_COMMIT"
            echo "PR title: $PR_TITLE"

            # Fetch target branch
            echo "Fetching target branch: $TARGET_BRANCH..."
            git fetch origin "$TARGET_BRANCH" 2>&1 || ERROR="Target branch '$TARGET_BRANCH' does not exist or cannot be fetched"
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            # Check if a cherry-pick PR already exists
            CHERRY_PICK_BRANCH="cherry-pick-$PR_NUMBER-to-$TARGET_BRANCH"
            echo "Checking for existing cherry-pick PR..."
            EXISTING_PR=$(gh pr list \
              --repo ${{ github.repository }} \
              --head "$CHERRY_PICK_BRANCH" \
              --base "$TARGET_BRANCH" \
              --json number,url \
              --jq '.[0] | select(. != null)') || ERROR="Failed to check for existing PR"
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            UPDATE_EXISTING=false
            if [ -n "$EXISTING_PR" ]; then
              PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
              PR_NUM=$(echo "$EXISTING_PR" | jq -r '.number')
              echo "‚ÑπÔ∏è  Cherry-pick PR already exists: #$PR_NUM - will update it"
              echo "URL: $PR_URL"
              echo "existing_pr_url=$PR_URL" >> $GITHUB_OUTPUT
              echo "existing_pr_number=$PR_NUM" >> $GITHUB_OUTPUT
              UPDATE_EXISTING=true
            fi

            # Create or reset branch for cherry-pick
            if [ "$UPDATE_EXISTING" = "true" ]; then
              echo "Resetting cherry-pick branch: $CHERRY_PICK_BRANCH to origin/$TARGET_BRANCH..."
              git checkout -B "$CHERRY_PICK_BRANCH" "origin/$TARGET_BRANCH" || ERROR="Failed to reset cherry-pick branch"
            else
              echo "Creating cherry-pick branch: $CHERRY_PICK_BRANCH..."
              git checkout -b "$CHERRY_PICK_BRANCH" "origin/$TARGET_BRANCH" || ERROR="Failed to create cherry-pick branch"
            fi
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            # Get all commits from the PR (for rebase-merged PRs, we need all commits, not just the merge commit)
            echo "Fetching commits from PR #$PR_NUMBER..."
            COMMITS=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json commits --jq '.commits[].oid') || ERROR="Failed to fetch PR commits"
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
            echo "Found $COMMIT_COUNT commit(s) to cherry-pick"

            # Fetch the PR commits - they may be from a fork and not available locally
            # GitHub makes PR commits available via refs/pull/<number>/head
            echo "Fetching PR ref to make fork commits available locally..."
            git fetch origin "pull/$PR_NUMBER/head" 2>&1 || ERROR="Failed to fetch PR commits from refs/pull/$PR_NUMBER/head"
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            # Cherry-pick each commit in order
            CURRENT=0
            for COMMIT in $COMMITS; do
              CURRENT=$((CURRENT + 1))
              echo "Cherry-picking commit $CURRENT/$COMMIT_COUNT: $COMMIT..."
              git cherry-pick "$COMMIT" 2>&1 || ERROR="Cherry-pick failed for commit $COMMIT due to conflicts or other errors"
              if [[ "$ERROR" != "" ]]; then
                echo "‚ùå ERROR: $ERROR"
                git cherry-pick --abort 2>/dev/null || true
                exit 1
              fi
            done
            echo "Successfully cherry-picked all $COMMIT_COUNT commit(s)"

            # Push the branch (force push if updating existing PR)
            if [ "$UPDATE_EXISTING" = "true" ]; then
              echo "Force pushing to update existing cherry-pick branch..."
              git push --force origin "$CHERRY_PICK_BRANCH" 2>&1 || ERROR="Failed to force push branch '$CHERRY_PICK_BRANCH' to remote. This might be due to missing 'workflow' scope on the token when modifying workflow files"
            else
              echo "Pushing cherry-pick branch..."
              git push origin "$CHERRY_PICK_BRANCH" 2>&1 || ERROR="Failed to push branch '$CHERRY_PICK_BRANCH' to remote. This might be due to missing 'workflow' scope on the token when modifying workflow files"
            fi
            if [[ "$ERROR" != "" ]]; then
              echo "‚ùå ERROR: $ERROR"
              exit 1
            fi

            # Create pull request only if not updating existing
            if [ "$UPDATE_EXISTING" = "true" ]; then
              echo "‚úÖ Updated existing cherry-pick PR: $PR_URL"
              echo "updated_pr=true" >> $GITHUB_OUTPUT
            else
              echo "Creating pull request..."

              # Prepare PR body file
              {
                echo "This is a cherry-pick of #$PR_NUMBER"
                echo ""
                echo "---"
                echo ""
                echo "$PR_BODY"
              } > /tmp/pr-body.md

              # Create pull request with original PR content
              PR_URL=$(gh pr create \
                --repo ${{ github.repository }} \
                --base "$TARGET_BRANCH" \
                --head "$CHERRY_PICK_BRANCH" \
                --title "[cherry-pick: $TARGET_BRANCH] $PR_TITLE" \
                --body-file /tmp/pr-body.md 2>&1) || ERROR="Failed to create pull request"

              if [[ "$ERROR" != "" ]]; then
                echo "‚ùå ERROR: $ERROR"
                echo "Output: $PR_URL"
                exit 1
              fi

              echo "Created PR: $PR_URL"
              echo "new_pr_url=$PR_URL" >> $GITHUB_OUTPUT
              echo "‚úÖ Cherry-pick completed successfully!"
            fi
          } 2>&1 | tee "$OUTPUT_FILE"

          EXIT_CODE=${PIPESTATUS[0]}

          # Save output for use in comments
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "output<<$EOF" >> $GITHUB_OUTPUT
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

          rm -f "$OUTPUT_FILE"
          exit $EXIT_CODE

      - name: Comment on updated PR
        if: steps.cherry-pick.outcome == 'success' && steps.cherry-pick.outputs.updated_pr == 'true'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.CHATOPS_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            üîÑ **Cherry-pick to `${{ matrix.branch }}` updated!**

            The existing cherry-pick PR #${{ steps.cherry-pick.outputs.existing_pr_number }} has been updated with the latest changes.

            **PR**: ${{ steps.cherry-pick.outputs.existing_pr_url }}

      - name: Comment on success
        if: steps.cherry-pick.outcome == 'success' && steps.cherry-pick.outputs.existing_pr_url == ''
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.CHATOPS_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            ‚úÖ **Cherry-pick to `${{ matrix.branch }}` successful!**

            A new pull request has been created to cherry-pick this change to `${{ matrix.branch }}`.

            **PR**: ${{ steps.cherry-pick.outputs.new_pr_url }}

            Please review and merge the cherry-pick PR.

      - name: Comment on failure
        if: steps.cherry-pick.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.CHATOPS_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            ‚ùå **Cherry-pick to `${{ matrix.branch }}` failed!**

            The automatic cherry-pick to `${{ matrix.branch }}` failed.

            **Output:**
            ```
            ${{ steps.cherry-pick.outputs.output }}
            ```

            **Next steps:**
            - Check the [action logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete details
            - If the PR is not merged, merge it first and try again
            - If there are conflicts, you'll need to manually cherry-pick this PR
